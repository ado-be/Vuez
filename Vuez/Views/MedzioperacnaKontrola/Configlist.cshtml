@model vuez.Models.ViewModels.ProgramItemConfigViewModel
@{
    // Získat configId z URL
    var configIdString = Context.Request.Query["configId"].ToString();
    var configId = 0;
    int.TryParse(configIdString, out configId);

    // Pokud není v URL, zkusit z modelu
    if (configId <= 0 && Model?.ConfigurationSheet?.ConfigId > 0)
    {
        configId = Model.ConfigurationSheet.ConfigId;
    }
}

<h1>Konfiguračný list</h1>



<!-- Manuální formulář bez model bindingu -->
<form method="post" action="/MedzioperacnaKontrola/SaveFormData">
    @Html.AntiForgeryToken()

    <!-- Identifikátory pro zpracování -->
    <input type="hidden" name="configId" value="@configId" />
    <input type="hidden" name="itemId" value="@(Model?.Item?.ItemId ?? 0)" />
    <input type="hidden" name="detailId" value="@(Model?.Detail?.DetailId ?? 0)" />
    <input type="hidden" name="ppnumber" value="@(Model?.Detail?.Ppnumber ?? "")" class="form-control" />
    <input type="hidden" name="ppname" value="@(Model?.Detail?.Ppname ?? "")" class="form-control" />

    <div class="protocol-container">
        <h2>Základné informácie</h2>

        <table class="header-table">
            <tr>
                <td class="logo">
                    <img src="~/images/VUEZlogo.png" alt="VUEZ Logo" class="logo-img" />
                </td>
                <td class="company-name">
                    <h3>V Ú E Z, a.s.</h3>
                </td>
            </tr>
        </table>

        <table class="form-table">
            <!-- Položka -->
            <tr>
                <td>Číslo položky:</td>
                <td>
                    <input type="text" name="itemCode" value="@(Model?.Item?.ItemCode ?? "")" class="form-control" required />
                </td>
            </tr>
            <tr>
                <td>Názov položky:</td>
                <td>
                    <input type="text" name="itemName" value="@(Model?.Item?.ItemName ?? "")" class="form-control" required />
                </td>
            </tr>
            <tr>
                <td>Popis položky:</td>
                <td>
                    <input type="text" name="itemDescription" value="@(Model?.Item?.ItemDescription ?? "")" class="form-control" />
                </td>
            </tr>

            <!-- Konfiguračné údaje (readonly) -->
            <tr>
                <td>Názov APV:</td>
                <td>
                    <input type="text" class="form-control" value="@(Model?.ConfigurationSheet?.Apvname ?? "")" readonly />
                </td>
            </tr>
            <tr>
                <td>Číslo zmluvy:</td>
                <td>
                    <input type="text" class="form-control" value="@(Model?.ConfigurationSheet?.Apvnumber ?? "")" readonly />
                </td>
            </tr>
            <tr>
                <td>Číslo zákazky:</td>
                <td>
                    <input type="text" class="form-control" value="@(Model?.ConfigurationSheet?.OrderNumber ?? "")" readonly />
                </td>
            </tr>

            <!-- Detail -->
                   
            <tr>
                <td>Spracovateľ:</td>
                <td>
                    <input type="text" name="modifiedBy" value="@(Model?.Detail?.ModifiedBy ?? "")" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Číslo počiatočnej verzie:</td>
                <td>
                    <input type="text" name="initialVersionNumber" value="@(Model?.Detail?.InitialVersionNumber ?? "")" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Vývojové nástroje:</td>
                <td>
                    <input type="text" name="developmentTools" value="@(Model?.Detail?.DevelopmentTools ?? "")" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Vývojové PC:</td>
                <td>
                    <input type="text" name="developmentPc" value="@(Model?.Detail?.DevelopmentPc ?? "")" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Pripojenia:</td>
                <td>
                    <input type="text" name="connections" value="@(Model?.Detail?.Connections ?? "")" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Súvisiaca dokumentácia:</td>
                <td>
                    <input type="text" name="relatedDocumentation" value="@(Model?.Detail?.RelatedDocumentation ?? "")" class="form-control" />
                </td>
            </tr>
            <tr>
                <td>Poznámky:</td>
                <td>
                    <textarea name="notes" class="form-control" rows="3">@(Model?.Detail?.Notes ?? "")</textarea>
                </td>
            </tr>
        </table>

        <!-- Validační chyby -->
        @if (TempData.ContainsKey("ErrorMessage"))
        {
            <div class="alert alert-danger">
                @TempData["ErrorMessage"]
            </div>
        }

        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger">
                <ul>
                    @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
                    {
                        <li>@error.ErrorMessage</li>
                    }
                </ul>
            </div>
        }

        <div class="form-group mt-3">
            <button type="submit" class="btn btn-success">Uložiť zmeny</button>
            <a href="/MedzioperacnaKontrola/ExamRecord?configId=@configId" class="btn btn-primary">Pokračovať na záznam o kontrole</a>
        </div>
    </div>
</form>

<!-- Diagnostický JavaScript -->
<script>
    document.querySelector('form').addEventListener('submit', function (e) {
        // Logování odesílaných dat
        console.log('Odesílaná data:');
        var formData = new FormData(this);
        for (var pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        // Kontrola povinných polí
        var configId = document.querySelector('input[name="configId"]').value;
        var itemCode = document.querySelector('input[name="itemCode"]').value;
        var itemName = document.querySelector('input[name="itemName"]').value;
        var ppname = document.querySelector('input[name="ppname"]').value;
        var ppnumber = document.querySelector('input[name="ppnumber"]').value;

        if (!configId || configId <= 0) {
            console.error('Chybí configId!');
        }

        if (!itemCode) {
            console.error('Chybí kód položky!');
        }

        if (!itemName) {
            console.error('Chybí název položky!');
        }
    });
</script>